---
title: "A short demo of the anonymisation process"
author: "Sinan Shi"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    include: 
      in_header: vignettes/report.latex
---

```{r include=FALSE}
library(ccdata)
library(ccanonym)
library(pander)

panderOptions('table.split.table', 115)
```
```{r}
library(ccdata)
library(ccanonym)
```


# The YAML configuration file
Create a YAML configuration file as such, where the **identifiable variables**
(dirctVars), **key categorical variables** (keyVars), **key numerical
variables** (numVars), **key date-time variables** (datetimeVars), **sensitive variables**
(sensVars) and the corresponding operations and thresholds are specified. 

```{yaml}
directVars:
    - pasno   
    - ICNNO   
    - NHSNO   
    - DOB
categoryVars:
    - GPCODE 
    - SEX
    - PCODE #  Postcode
numVars:
    HCM:  # Height
        aggr: 2
    AGE:
        aggr: 2
datetimeVars:
    DAH: # Date of admission to your hospital
        aggr: 2
sensVars:
    - AIDS_V3 # HIC/AIDS

... ...

```


```{r, echo=FALSE}
conf <- yaml.load_file("../data/test_demo.yaml")
vars <- anony.var(conf)
all.var <- c(vars$dirv, vars$all.vars, "DIS") # all variables besides non-confidential data 
all.var.origin <- all.var[-which(all.var=="AGE")]
```

# Identifiable data set

The identifiable data set is usually stored in _ccRecord_ format, which is the
default for CCHIC data. In the following code, we create the ccRecord object
from an XML file which contains only five episodes. 

```{r pander,  warning=FALSE}
ccd <- xml2Data("../tests/data/test_data_anonym.xml")
demg.table <- as.data.frame(sql.demographic.table(ccd))
pander(demg.table[, all.var.origin],  style = 'rmarkdown')
```

# Anonymisation procedure
```{yaml}
numVars:
    HCM:  # Height
        aggr: 2
```
```{r, results="hide", warning=FALSE}
sdc <- sdc.trial(ccd, conf, remove.alive=T, verbose=T, k=1)
```
```{r, echo=FALSE}
pander(data.frame(HCM_ORIG=demg.table$HCM[1:5], HCM_ANON=sdc$data$HCM), style="rmarkdown")
```
```{yaml}
numVars:
    HCM:  # Height
        aggr: 3
```
```{r, results="hide", warning=FALSE}
sdc <- sdc.trial(ccd, conf, remove.alive=T, verbose=T, k=1)
```
```{r, echo=FALSE}
pander(data.frame(HCM_ORIG=demg.table$HCM[1:5], HCM_ANON=sdc$data$HCM), style="rmarkdown")
```

